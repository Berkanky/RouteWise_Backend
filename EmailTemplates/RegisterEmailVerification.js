const sgMail = require("@sendgrid/mail");
const createVerifyCode = require("../MyFunctions/GenerateVerifyCode"); // Bu fonksiyonun string döndürdüğünü varsayıyoruz

sgMail.setApiKey(process.env.SENDGRID_API_KEY);

var sendGridFromEMailAddress = process.env.EMAIL_ADDRESS;

const RegisterEmailVerification = async (EMailAddress) => {
  var verificationCodeString = createVerifyCode();
  var verificationDigits = verificationCodeString.split("");

  var codeSpans = verificationDigits
    .map(
      (digit) =>
        `<span style="display: inline-block; width: 35px; height: 45px; border: 1px solid #cccccc; border-radius: 4px; text-align: center; line-height: 45px; font-size: 20px; font-weight: bold; color: #333; margin-right: 8px;">${digit}</span>`
    )
    .join("");

  const msg = {
    to: EMailAddress,
    from: {
      email: sendGridFromEMailAddress,
      name: "RouteWise",
    },
    subject: "RouteWise Email Verification",
    html: `
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteWise Email Verification</title>
</head>
<body style="font-family: Arial, Helvetica, sans-serif; line-height: 1.6; color: #333; background-color: #f4f4f4; margin: 0; padding: 20px;">

    <div style="max-width: 600px; margin: 20px auto; padding: 30px; background-color: #ffffff; border: 1px solid #e0e0e0; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">

        <div class="logo-placeholder" style="min-height: 40px; margin-bottom: 25px; display: flex; align-items: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="200" height="59" viewBox="0 0 200 59" fill="none">
              <path d="M29.3429 41.0357C29.4834 40.9374 29.6239 40.8391 29.7643 40.7478C30.4315 40.2983 31.0917 39.8277 31.7449 39.3431C35.1301 36.8218 38.2343 33.7877 40.0182 29.932C44.8994 19.3621 40.3483 6.85378 29.8486 1.86731C19.7563 -2.66266 7.97134 1.32649 2.65477 10.8359C2.38087 11.3135 2.12803 11.8122 1.88924 12.3249C0.61102 15.099 0.0983279 18.105 0.0140494 21.146C0.0140494 21.455 0 21.771 0 22.0801V58.1372H3.86276C4.97243 57.3717 6.08912 56.6061 7.21283 55.8406C9.88165 54.0076 12.5856 52.1956 15.2755 50.4047L18.471 48.2766L25.9508 58.1513L44.8994 58.1372L29.3429 41.0357ZM11.792 16.904C11.8482 16.7705 11.9114 16.6371 11.9816 16.5036C12.1431 16.1876 12.3187 15.8927 12.5083 15.6117C12.5435 15.5485 12.5786 15.4923 12.6277 15.4361C15.2404 11.6366 20.3041 10.0353 24.6655 11.7981C24.8341 11.8684 24.9886 11.9526 25.1571 12.0299C25.3187 12.1071 25.4872 12.1633 25.6487 12.2546C30.1928 14.6214 32.2365 20.2189 30.2911 24.9596C29.2306 27.5512 27.229 29.4474 24.8551 30.4236C24.3635 30.6343 23.8508 30.8029 23.3241 30.9293C23.303 30.9364 23.2889 30.9363 23.2679 30.9434C21.1679 31.435 18.8854 31.2594 16.7714 30.2832L16.6942 30.2481C15.437 29.6651 14.3625 28.8575 13.4846 27.8953C12.3538 26.6522 11.5532 25.1492 11.1529 23.5339C10.9562 22.7543 10.8579 21.9537 10.8579 21.146C10.8579 19.7273 11.1529 18.2805 11.792 16.904Z" fill="url(#paint0_linear_3387_1806)"/>
              <path d="M76.5249 31.6316C76.6021 31.6035 76.6794 31.5684 76.7496 31.5333C77.8031 31.0346 78.6108 30.3183 79.1726 29.3842C79.7275 28.4501 80.0084 27.3404 80.0084 26.0482C80.0084 24.7559 79.7345 23.6322 79.1867 22.677C78.6318 21.7148 77.8382 20.9774 76.7918 20.4506C75.7453 19.9239 74.4811 19.657 72.9852 19.657H65.3369V39.2869H69.3542V32.2777H72.5006L76.251 39.2869H80.7037L76.5249 31.6316ZM69.3542 22.979H72.2337C73.0624 22.979 73.7367 23.0984 74.2704 23.3302C74.8042 23.569 75.1975 23.9131 75.4644 24.3696C75.7242 24.8191 75.8577 25.381 75.8577 26.0482C75.8577 26.7154 75.7242 27.2421 75.4644 27.6846C75.1975 28.127 74.8042 28.4641 74.2775 28.6889C73.7507 28.9136 73.0765 29.026 72.2477 29.026H69.3542V22.979Z" fill="black"/>
              <path d="M89.2087 39.5748C87.7339 39.5748 86.4556 39.2588 85.3741 38.6197C84.2925 37.9805 83.4638 37.0956 82.8808 35.9579C82.2979 34.8201 82.0029 33.4998 82.0029 31.9898C82.0029 30.4798 82.2979 29.1313 82.8808 27.9936C83.4638 26.8558 84.2995 25.9709 85.3741 25.3318C86.4556 24.6927 87.7339 24.3766 89.2087 24.3766C90.6836 24.3766 91.9759 24.6927 93.0504 25.3318C94.125 25.9709 94.9537 26.8558 95.5366 27.9936C96.1196 29.1313 96.4145 30.4658 96.4145 31.9898C96.4145 33.5138 96.1196 34.8271 95.5366 35.9579C94.9537 37.0956 94.125 37.9805 93.0504 38.6197C91.9759 39.2588 90.6977 39.5748 89.2087 39.5748ZM89.2087 36.4636C89.9111 36.4636 90.501 36.2669 90.9716 35.8806C91.4491 35.4873 91.8003 34.9536 92.0391 34.2723C92.2779 33.5911 92.3973 32.8255 92.3973 31.9757C92.3973 31.1259 92.2779 30.3323 92.0391 29.6581C91.8003 28.9839 91.4491 28.4501 90.9716 28.0638C90.494 27.6775 89.9111 27.4809 89.2087 27.4809C88.5064 27.4809 87.9165 27.6705 87.4529 28.0638C86.9824 28.4501 86.6312 28.9839 86.3924 29.6581C86.1536 30.3323 86.0342 31.1049 86.0342 31.9757C86.0342 32.8466 86.1536 33.5911 86.3924 34.2723C86.6312 34.9536 86.9824 35.4873 87.4529 35.8806C87.9235 36.2739 88.5064 36.4636 89.2087 36.4636Z" fill="black"/>
              <path d="M112.61 24.5593V39.2869H108.867L108.818 36.2037C108.445 37.1589 107.926 37.9104 107.266 38.4652C106.472 39.1324 105.461 39.4695 104.246 39.4695C103.227 39.4695 102.335 39.2448 101.57 38.8023C100.804 38.3598 100.214 37.7207 99.7999 36.892C99.3785 36.0633 99.1748 35.073 99.1748 33.9212V24.5593H103.122V33.2399C103.122 34.1529 103.361 34.8693 103.838 35.382C104.309 35.9017 104.962 36.1616 105.784 36.1616C106.345 36.1616 106.844 36.0422 107.273 35.8034C107.701 35.5576 108.038 35.2064 108.277 34.7499C108.523 34.2864 108.642 33.7316 108.642 33.0784V24.5593H112.61Z" fill="black"/>
              <path d="M123.685 39.1394C123.243 39.2729 122.808 39.3641 122.372 39.4133C121.937 39.4695 121.522 39.4976 121.129 39.4976C119.654 39.4976 118.523 39.1324 117.744 38.416C116.964 37.6926 116.571 36.6602 116.571 35.3188V27.5722H114.541V24.5593H116.571V21.0547H120.525V24.5593H123.278V27.5722H120.525V34.9747C120.525 35.4452 120.623 35.7894 120.834 36.0141C121.038 36.2318 121.382 36.3442 121.866 36.3442C122.014 36.3442 122.225 36.3302 122.499 36.288C122.772 36.2459 122.976 36.2107 123.117 36.1756L123.685 39.1394Z" fill="black"/>
              <path d="M138.954 31.8423C138.954 30.5781 138.771 29.4825 138.42 28.5484C138.062 27.6213 137.571 26.8418 136.938 26.2237C136.306 25.6057 135.569 25.1422 134.733 24.8331C133.904 24.5241 132.998 24.3766 132.036 24.3766C130.604 24.3766 129.36 24.6927 128.293 25.3388C127.232 25.9779 126.411 26.8698 125.835 28.0076C125.252 29.1524 124.964 30.4798 124.964 32.0038C124.964 33.5278 125.252 34.8974 125.835 36.0281C126.425 37.1659 127.26 38.0368 128.349 38.6548C129.438 39.2658 130.73 39.5748 132.233 39.5748C133.385 39.5748 134.403 39.4063 135.281 39.0762C136.166 38.7391 136.903 38.2685 137.486 37.6575C138.076 37.0465 138.491 36.3371 138.729 35.5295L135.148 34.8623C135 35.2345 134.796 35.5575 134.529 35.8104C134.263 36.0702 133.94 36.2669 133.56 36.4003C133.188 36.5338 132.767 36.597 132.296 36.597C131.615 36.597 131.018 36.4495 130.498 36.1615C129.985 35.8736 129.585 35.4382 129.304 34.8623C129.044 34.3355 128.904 33.6964 128.89 32.952H138.954V31.8423ZM128.897 30.4728C128.939 29.9741 129.051 29.5246 129.241 29.1103C129.487 28.5695 129.852 28.141 130.33 27.825C130.807 27.5089 131.39 27.3474 132.078 27.3474C132.767 27.3474 133.321 27.509 133.778 27.818C134.242 28.127 134.586 28.5694 134.824 29.1383C134.986 29.5316 135.091 29.9741 135.133 30.4728H128.897Z" fill="black"/>
              <path d="M162.117 24.5593L157.748 39.2869H153.731L152.094 33.6051C151.94 33.0363 151.778 32.4042 151.624 31.7159C151.462 31.0276 151.308 30.3253 151.16 29.6089C151.125 29.4334 151.09 29.2648 151.055 29.0962C151.02 29.2648 150.978 29.4334 150.943 29.6089C150.788 30.3253 150.634 31.0276 150.479 31.7229C150.318 32.4182 150.163 33.0433 150.002 33.6051L148.365 39.2869H144.348L140.008 24.5593H144.151L145.429 29.9952C145.647 30.9714 145.886 32.0319 146.146 33.1767C146.314 33.9563 146.476 34.778 146.63 35.6629C146.792 34.8061 146.961 33.9844 147.143 33.2189C147.417 32.0671 147.67 30.9925 147.909 29.9952L149.25 24.5593H152.888L154.201 29.9952C154.426 30.9925 154.672 32.06 154.939 33.2048C155.122 33.9844 155.304 34.8131 155.466 35.691C155.613 34.8201 155.775 33.9914 155.936 33.2189C156.175 32.0741 156.414 30.9995 156.639 29.9952L157.917 24.5593H162.117Z" fill="black"/>
              <path d="M168.36 20.6052C168.36 21.167 168.149 21.6446 167.728 22.0449C167.3 22.4382 166.787 22.6349 166.19 22.6349C165.593 22.6349 165.08 22.4382 164.659 22.0449C164.238 21.6446 164.027 21.167 164.027 20.6052C164.027 20.0433 164.238 19.5658 164.659 19.1725C165.08 18.7792 165.593 18.5755 166.19 18.5755C166.787 18.5755 167.3 18.7792 167.728 19.1725C168.149 19.5658 168.36 20.0433 168.36 20.6052Z" fill="black"/>
              <path d="M168.164 24.5593H164.217V39.2869H168.164V24.5593Z" fill="black"/>
              <path d="M177.371 39.5749C176.184 39.5749 175.138 39.4063 174.225 39.0692C173.312 38.7321 172.567 38.2405 171.984 37.5943C171.401 36.9482 171.029 36.1686 170.867 35.2556L174.541 34.6235C174.73 35.3118 175.074 35.8245 175.552 36.1616C176.029 36.4987 176.683 36.6743 177.49 36.6743C178.249 36.6743 178.839 36.5338 179.274 36.2459C179.71 35.9579 179.927 35.5997 179.927 35.1573C179.927 34.771 179.773 34.455 179.457 34.2091C179.148 33.9633 178.67 33.7737 178.024 33.6403L175.482 33.1135C174.056 32.8256 172.995 32.3269 172.293 31.6316C171.591 30.9293 171.24 30.0374 171.24 28.9347C171.24 27.9866 171.5 27.1719 172.019 26.4907C172.539 25.8094 173.255 25.2827 174.182 24.9175C175.109 24.5523 176.191 24.3626 177.434 24.3626C178.593 24.3626 179.597 24.5241 180.447 24.8402C181.297 25.1632 181.985 25.6127 182.512 26.2027C183.039 26.7926 183.39 27.4879 183.565 28.2816L180.061 28.8996C179.913 28.401 179.625 27.9866 179.197 27.6705C178.769 27.3475 178.2 27.1859 177.476 27.1859C176.823 27.1859 176.282 27.3194 175.84 27.5933C175.397 27.8672 175.18 28.2324 175.18 28.6889C175.18 29.0612 175.32 29.3701 175.608 29.623C175.896 29.8758 176.381 30.0725 177.076 30.2129L179.724 30.7397C181.149 31.0276 182.203 31.4982 182.898 32.1584C183.593 32.8115 183.938 33.6683 183.938 34.7218C183.938 35.691 183.657 36.5338 183.095 37.2572C182.533 37.9806 181.76 38.5425 180.77 38.9498C179.78 39.3572 178.642 39.5538 177.35 39.5538L177.371 39.5749Z" fill="black"/>
              <path d="M200 31.8423C200 30.5781 199.824 29.4825 199.466 28.5484C199.115 27.6213 198.616 26.8418 197.984 26.2237C197.352 25.6057 196.622 25.1422 195.786 24.8331C194.95 24.5241 194.051 24.3766 193.089 24.3766C191.656 24.3766 190.406 24.6927 189.346 25.3388C188.285 25.9779 187.464 26.8698 186.881 28.0076C186.305 29.1524 186.017 30.4798 186.017 32.0038C186.017 33.5278 186.305 34.8974 186.888 36.0281C187.471 37.1659 188.313 38.0368 189.402 38.6548C190.491 39.2658 191.783 39.5748 193.286 39.5748C194.438 39.5748 195.449 39.4063 196.334 39.0762C197.219 38.7391 197.949 38.2685 198.539 37.6575C199.129 37.0465 199.544 36.3371 199.775 35.5295L196.193 34.8623C196.053 35.2345 195.849 35.5575 195.582 35.8104C195.316 36.0702 194.992 36.2669 194.613 36.4003C194.241 36.5338 193.82 36.597 193.349 36.597C192.668 36.597 192.064 36.4495 191.551 36.1615C191.038 35.8736 190.638 35.4382 190.35 34.8623C190.097 34.3355 189.957 33.6964 189.943 32.952H200V31.8423ZM189.95 30.4728C189.992 29.9741 190.104 29.5246 190.294 29.1103C190.54 28.5695 190.905 28.141 191.383 27.825C191.86 27.5089 192.443 27.3474 193.124 27.3474C193.806 27.3474 194.374 27.509 194.831 27.818C195.294 28.127 195.639 28.5694 195.87 29.1383C196.039 29.5316 196.144 29.9741 196.186 30.4728H189.95Z" fill="black"/>
              <defs>
                <linearGradient id="paint0_linear_3387_1806" x1="0.112481" y1="8.42785" x2="45.061" y2="58.2926" gradientUnits="userSpaceOnUse">
                  <stop stop-color="#FF5A5F"/>
                  <stop offset="0.8" stop-color="#D10000"/>
                </linearGradient>
              </defs>
            </svg>
        </div>

        <p style="margin-bottom: 15px; font-size: 15px; color: #555; font-weight: bold;">Hi ${EMailAddress},</p>

        <p style="margin-bottom: 15px; font-size: 15px; color: #555;">
           Thank you for signing up! To continue using our app, please verify your email address by entering the code below:
        </p>

        <div style="display: flex; align-items: center; gap: 15px; margin: 25px 0;">
            <div style="display: flex; gap: 0px;"> ${codeSpans}
            </div>
            <a href="#" target="_blank" style="background-color: #e74c3c; color: white; border: none; padding: 10px 18px; border-radius: 5px; cursor: default; font-size: 14px; font-weight: bold; text-decoration: none; white-space: nowrap;">Kopyala</a>
             </div>

        <p style="font-size: 13px; color: #777777; margin-top: 25px;">
           If you did not request this, you can safely ignore this email.
        </p>
         <p style="font-size: 13px; color: #777777; margin-top: 10px;">
            Need help? Feel free to contact us anytime!
         </p>

        <p style="margin-top: 25px; font-size: 15px; color: #555;">
           Best Regards,<br>
           <strong>The RouteWise Team</strong>
           
        </p>

        <div style="border-top: 1px solid #eeeeee; margin: 20px 0;"></div> <p style="font-size: 12px; color: #aaaaaa; text-align: right; margin-top: 10px; margin-bottom: 0;">
           &copy; ${new Date().getFullYear()} RouteWise. All Rights Reserved.
        </p>
    </div>
</body>
</html>
    `,
  };

  try {
    await sgMail.send(msg);
    return verificationCodeString;
  } catch (error) {
    if (error.response) console.error("Hata Detayları:", error.response.body);
    return null;
  }
};

module.exports = RegisterEmailVerification;